<!DOCTYPE html>
<html>
<head>
  <title>Weather Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
  <h1>Temperature and Humidity (Past & Future 24h)</h1>
  <div style="width: 50vw;">
    <canvas id="comboChart"></canvas>
  </div>
  <script>
    async function fetchData(url) {
      const res = await fetch(url);
      return res.json();
    }

    async function drawComboChart() {
      const forecast = await fetchData('/api/forecast');

      const foreLabels = forecast.map(d => {
        const date = new Date(d.timestamp);
        const day = date.getDate().toString().padStart(2, '0');
        const month = date.toLocaleString('en-US', { month: 'short' });
        let hour = date.getHours();
        const ampm = hour >= 12 ? 'pm' : 'am';
        hour = hour % 12;
        hour = hour === 0 ? 12 : hour; // Convert 0 to 12 for 12-hour format
        const minute = date.getMinutes().toString().padStart(2, '0');
        return `${day}-${month} ${hour}:${minute} ${ampm}`;
      });
      const foreTemps = forecast.map(d => d.temperature);
      const foreHumids = forecast.map(d => d.humidity);

      const shiftedLabels = foreLabels.slice(0, -1);
      const shiftedTemps = foreTemps.slice(1);
      const shiftedHumids = foreHumids.slice(1);

      const datasets = [
        {
          label: 'Temperature - Forecast',
          data: shiftedTemps,
          borderColor: 'red',
          yAxisID: 'y1',
          fill: false,
          tension: 0.4
        },
        {
          label: 'Humidity - Forecast',
          data: shiftedHumids,
          borderColor: 'blue',
          yAxisID: 'y',
          fill: false,
          tension: 0.4
        }
      ];

      const now = new Date();
      const nowISO = now.toISOString().slice(0, 19); // match your label format

      // Find the index of the first label at midnight
      const midnightIndex = foreLabels.findIndex(label => label.endsWith("12:00 am"));
      const highlightStart = foreLabels[midnightIndex];
      const highlightEnd = foreLabels[midnightIndex + 8]; // 24 hours later

      new Chart(document.getElementById('comboChart'), {
        type: 'line',
        data: {
          labels: shiftedLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Humidity (%)' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Temperature (Â°F)' },
              grid: { drawOnChartArea: false }
            }
          },
          plugins: {
            annotation: {
              annotations: {
                highlightDay: {
                  type: 'box',
                  xMin: highlightStart,
                  xMax: highlightEnd,
                  backgroundColor: 'rgba(255, 206, 86, 0.2)', // light yellow
                  borderWidth: 0
                }
              }
            }
          }
        }
      });
    }
    drawComboChart();
  </script>
</body>
</html> 