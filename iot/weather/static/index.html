<!DOCTYPE html>
<html>
<head>
  <title>Weather Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
  <h1>Temperature and Humidity (Past & Future 24h)</h1>
  <div style="width: 50vw;">
    <canvas id="comboChart"></canvas>
  </div>
  <script>
    async function fetchData(url) {
      const res = await fetch(url);
      return res.json();
    }

    async function drawComboChart() {
      const history = await fetchData('/api/history');
      const forecast = await fetchData('/api/forecast');

      const histLabels = history.map(d => d.timestamp);
      const histTemps = history.map(d => d.temperature);
      const histHumids = history.map(d => d.humidity);

      const foreLabels = forecast.map(d => d.timestamp);
      const foreTemps = forecast.map(d => d.temperature);
      const foreHumids = forecast.map(d => d.humidity);

      const labels = histLabels.concat(foreLabels).map(label => {
        const date = new Date(label);
        const day = date.getDate().toString().padStart(2, '0');
        const month = date.toLocaleString('en-US', { month: 'short' });
        let hour = date.getHours();
        const ampm = hour >= 12 ? 'pm' : 'am';
        hour = hour % 12;
        hour = hour === 0 ? 12 : hour; // Convert 0 to 12 for 12-hour format
        const minute = date.getMinutes().toString().padStart(2, '0');
        return `${day}-${month} ${hour}:${minute} ${ampm}`;
      });
      console.log(labels);
      const temps = histTemps.concat(foreTemps);
      const humids = histHumids.concat(foreHumids);

      const now = new Date();
      const nowISO = now.toISOString().slice(0, 19); // match your label format

      new Chart(document.getElementById('comboChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Temperature (°F)',
              data: temps,
              borderColor: 'red',
              yAxisID: 'y1',
              fill: false
            },
            {
              label: 'Humidity (%)',
              data: humids,
              borderColor: 'blue',
              yAxisID: 'y',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Humidity (%)' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Temperature (°F)' },
              grid: { drawOnChartArea: false }
            }
          },
          plugins: {
            annotation: {
              annotations: {
                currentTimeLine: {
                  type: 'line',
                  xMin: nowISO,
                  xMax: nowISO,
                  borderColor: 'green',
                  borderWidth: 2,
                  label: {
                    content: 'Now',
                    enabled: true,
                    position: 'start'
                  }
                }
              }
            }
          }
        }
      });
    }
    drawComboChart();
  </script>
</body>
</html> 